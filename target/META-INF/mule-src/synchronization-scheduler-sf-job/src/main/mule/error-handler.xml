<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:email="http://www.mulesoft.org/schema/mule/email"
xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking"
xmlns:http="http://www.mulesoft.org/schema/mule/http"
xmlns:json-logger="http://www.mulesoft.org/schema/mule/json-logger"
xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
xmlns="http://www.mulesoft.org/schema/mule/core"
xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/json-logger http://www.mulesoft.org/schema/mule/json-logger/current/mule-json-logger.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd
http://www.mulesoft.org/schema/mule/email http://www.mulesoft.org/schema/mule/email/current/mule-email.xsd">

<error-handler name="api-error-handler">

<on-error-propagate enableNotifications="true"
logException="true" doc:name="On Error Propagate"
doc:id="a8fcd9de-f733-4654-9ba5-a6efc1cfd810" type="ANY">
<logger level="INFO" doc:name="error handler starts" doc:id="8fb94268-4d13-4131-ad0c-494c52f7f91d" message="errorHandlerStarts #[payload]"/>
			<flow-ref doc:name="error-handling-format-pattern"
name="error-handling-format-pattern" />
</on-error-propagate>
		

</error-handler>

<sub-flow name="error-handling-format-pattern"
doc:id="f25ad0f9-1742-4079-91b0-c1583dc00738">
<logger level="INFO" doc:name="error format log" doc:id="6923f89a-1569-4cb2-ac5b-0b85cdbf4a3e" message="error format log #[payload]"/>
		
<async doc:name="notification email"
doc:id="209bf2ac-c84f-44e8-aab7-08af110cf603">
<try doc:name="Try" doc:id="a014dabb-ecce-4e84-bb0f-6b973a7e9666" >
<ee:transform doc:name="prepare email" doc:id="8d133a27-c899-40c4-8ada-f087ba47c23d">
<ee:message>
</ee:message>
<ee:variables>
						<ee:set-variable variableName="email" ><![CDATA[%dw 2.0
output text/plain
var correlationId = if (not isEmpty(vars.correlationId)) vars.correlationId else correlationId
var na = "N/A"
---

"<html><head><style>" ++ p("smtpemail.tableCss") ++ "</style></head>" ++
"<body>" ++

"<h2>This is an automated notification email generated by Mulesoft CFS AR Aging flow.  Please do not reply to this message.</h2>" ++

"<h3>Error Notification</h3><hr>" ++

"<p>Timestamp: " ++ (now() as DateTime >> "UTC") ++ "</p><hr>" ++
"<p>App Name: " ++ (app.name default na ) ++ "</p>" ++
"<p>Component Name: " ++ (error.failingComponent default na ) ++ "</p>" ++
"<p>Correlation ID: " ++ correlationId ++ "</p>" ++
"<p>Action: " ++  "error occured and process stopped. Please check the error and work accordingly to resume the process" ++ "</p><hr>" ++
"<p>Error Type: " ++ (('[' ++ error.errorType.namespace ++ ':'
		 ++ error.errorType.identifier
		 ++ ']') default na) ++ "</p>" ++
"<p>Error Value: " ++ (error.description default na) ++ "</p>" ++
"<p>Error Details: " ++ (error.exception.message default na) ++ "</p><hr>" ++
"<p>Thank you:"  ++ "PHSS Business Integrations Services" ++ "</p>" ++
"</body>
</html>"]]></ee:set-variable>



</ee:variables>
</ee:transform>
<email:send doc:id="9e002372-b3a1-45cb-92d2-85885a27110d" config-ref="AWS_Email_SMTP" fromAddress="arc_phss@redcross.org" subject="mulesoft  ${MULE_ENV} - SFTP-SFDC_Sharepoint integration Process error with transaction reference ids:" doc:name="SFTP -SFDC_Sharepoint integration process Escalation" >
					<reconnect frequency="3000" count="3" />
					<email:to-addresses >
						<email:to-address value="phss_mulesoft_team@redcross.org" />
					</email:to-addresses>
					<email:headers ><![CDATA[#[output application/json
---
{"error-source" : "error found on SFTP-SFDC AR Aging integration",
"more-information": "for detail error information please see below"}]]]></email:headers>
					<email:body contentType="text/html">
						<email:content ><![CDATA[#[vars.email]]]></email:content>
					</email:body>
				</email:send>
				<error-handler >
<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="f0e41abf-1682-4495-a898-a6097103018e" >
<logger level="INFO" doc:name="error notificaton continue" doc:id="605f810d-b5ea-45dc-ad81-2e8fd66a1572" message="error notificaton continue #[payload]"/>
</on-error-continue>
</error-handler>
</try>
</async>

</sub-flow>
</mule>